import streamlit as st
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="AIå°‚é–€å®¶ç›¸è«‡ã‚¢ãƒ—ãƒª", layout="wide")

# === ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šç¾© ===
EXPERT_PROMPTS = {
    "æ³•å¾‹å°‚é–€å®¶": """ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªæ³•å¾‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®è³ªå•ã«å¯¾ã—ã¦ã€æ³•å¾‹çš„è¦³ç‚¹ã‹ã‚‰æ­£ç¢ºã§å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
- æ³•å¾‹ç”¨èªã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„
- å¿…è¦ã«å¿œã˜ã¦è¤‡æ•°ã®æ³•å¾‹åˆ†é‡ã®è¦³ç‚¹ã‹ã‚‰å›ç­”ã—ã¦ãã ã•ã„
- å…·ä½“çš„ãªä¾‹ç¤ºã‚„æ ¹æ‹ ã‚’å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„""",
    
    "åŒ»ç™‚å°‚é–€å®¶": """ã‚ãªãŸã¯åŒ»å­¦çŸ¥è­˜ãŒè±Šå¯ŒãªåŒ»ç™‚å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®è³ªå•ã«å¯¾ã—ã¦ã€åŒ»å­¦çš„è¦³ç‚¹ã‹ã‚‰è²¬ä»»ã‚’æŒã£ãŸå›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
- åŒ»å­¦ç”¨èªã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„
- ä¸€èˆ¬çš„ãªåŒ»å­¦çŸ¥è­˜ã¨æœ€æ–°ã®æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦å›ç­”ã—ã¦ãã ã•ã„
- å¿…è¦ãªå ´åˆã¯åŒ»å¸«ã®è¨ºå¯Ÿã‚’å‹§ã‚ã¦ãã ã•ã„""",
    
    "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢æŠ€è¡“å°‚é–€å®¶": """ã‚ãªãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®çµŒé¨“è±Šå¯ŒãªæŠ€è¡“å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æŠ€è¡“çš„ãªè³ªå•ã«å¯¾ã—ã¦ã€å®Ÿè·µçš„ã§è©³ç´°ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
- è¤‡æ•°ã®è§£æ±ºæ–¹æ³•ã‚’ææ¡ˆã™ã‚‹å ´åˆã¯ã€å„æ–¹æ³•ã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’èª¬æ˜ã—ã¦ãã ã•ã„
- ã‚³ãƒ¼ãƒ‰ä¾‹ã‚„å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã‚’å«ã‚ã¦ãã ã•ã„
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚„æœ€æ–°æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„"""
}

# === LLMã«å•ã„åˆã‚ã›ã‚‹é–¢æ•° ===
def get_expert_response(user_input: str, expert_type: str) -> str:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã¨å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ã€LLMã‹ã‚‰å›ç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    
    Args:
        user_input (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
        expert_type (str): é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®ã‚¿ã‚¤ãƒ—
    
    Returns:
        str: LLMã‹ã‚‰ã®å›ç­”
    """
    # ChatOpenAIãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
    llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.5)
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹ç¯‰
    messages = [
        SystemMessage(content=EXPERT_PROMPTS[expert_type]),
        HumanMessage(content=user_input)
    ]
    
    # LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
    result = llm.invoke(messages)
    
    return result.content

# === Streamlit UI ===

# ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
st.title("ğŸ¤– AIå°‚é–€å®¶ç›¸è«‡ã‚¢ãƒ—ãƒª")

st.markdown("""
### ğŸ“‹ ã‚¢ãƒ—ãƒªã®æ¦‚è¦
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ç•°ãªã‚‹åˆ†é‡ã®å°‚é–€å®¶ã¨ã—ã¦ã®AIã«è³ªå•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
é¸æŠã—ãŸå°‚é–€å®¶ã®çŸ¥è­˜ã¨çµŒé¨“ã‚’ã‚‚ã¨ã«ã€ã‚ãªãŸã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚

### ğŸ“– ä½¿ã„æ–¹
1. **å°‚é–€å®¶ã‚’é¸æŠ**: ä¸‹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‹ã‚‰ç›¸è«‡ã—ãŸã„åˆ†é‡ã®å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„
2. **è³ªå•ã‚’å…¥åŠ›**: ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
3. **é€ä¿¡**: ã€Œè³ªå•ã‚’é€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€AIã®å›ç­”ã‚’å—ã‘å–ã‚Šã¾ã™
4. **çµæœç¢ºèª**: ç”»é¢ä¸‹éƒ¨ã«å°‚é–€å®¶ã‹ã‚‰ã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

---
""")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«å°‚é–€å®¶é¸æŠã‚’é…ç½®
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    expert_type = st.radio(
        "ç›¸è«‡ã—ãŸã„åˆ†é‡ã®å°‚é–€å®¶ã‚’é¸æŠ:",
        list(EXPERT_PROMPTS.keys()),
        help="ç•°ãªã‚‹åˆ†é‡ã®å°‚é–€å®¶ã¨ã—ã¦æŒ¯ã‚‹èˆã†AIã‚’é¸æŠã—ã¾ã™"
    )

# ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
st.subheader(f"ğŸ¯ {expert_type}ã¸ã®è³ªå•")

# å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
user_input = st.text_area(
    "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
    placeholder="ã“ã“ã«è³ªå•å†…å®¹ã‚’å…¥åŠ›...",
    height=100,
    key="user_input"
)

# é€ä¿¡ãƒœã‚¿ãƒ³
if st.button("â“ è³ªå•ã‚’é€ä¿¡", type="primary"):
    if user_input.strip():
        with st.spinner("å›ç­”ã‚’ç”Ÿæˆä¸­..."):
            try:
                # é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
                response = get_expert_response(user_input, expert_type)
                
                # çµæœã‚’è¡¨ç¤º
                st.success("âœ… å›ç­”ãŒå®Œæˆã—ã¾ã—ãŸï¼")
                st.markdown("### ğŸ’¬ AIå°‚é–€å®¶ã‹ã‚‰ã®å›ç­”")
                st.markdown(response)
                
            except Exception as e:
                st.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
    else:
        st.warning("âš ï¸ è³ªå•ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„")